<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASTRAL - World Builder</title>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js for Mindmap -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Fallback for 'Love') -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <style>
      @font-face {
        font-family: "Love";
        src: url("Love.ttf") format("truetype"); /* Tries to find local file */
      }

      :root {
        --color-bg: #1a1b26;
        --color-card: #24283b;
        --color-accent: #5c2a2a; /* The dark red from your image */
        --color-text: #c0caf5;
        --color-gold: #e0af68;
      }

      body {
        background-color: var(--color-bg);
        color: var(--color-text);
        font-family: "Playfair Display", serif;
      }

      h1,
      h2,
      h3,
      .brand-font {
        font-family: "Love", "Cinzel", serif; /* Priority: Love -> Cinzel -> Serif */
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--color-bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--color-accent);
        border-radius: 4px;
      }

      .input-std {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid #414868;
        color: #c0caf5;
        padding: 0.5rem;
        width: 100%;
        outline: none;
        transition: border-color 0.2s;
      }
      .input-std:focus {
        border-color: var(--color-gold);
      }

      .btn-primary {
        background-color: var(--color-accent);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 2px;
        font-family: "Cinzel", serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: filter 0.2s;
      }
      .btn-primary:hover {
        filter: brightness(1.2);
      }

      .btn-secondary {
        border: 1px solid var(--color-accent);
        color: var(--color-text);
        padding: 0.4rem 0.8rem;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
        background: transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
      }
      .btn-secondary:hover {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-gold);
      }

      .toast-enter {
        transform: translateY(100%);
        opacity: 0;
      }
      .toast-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 300ms ease-out;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- ICONS ---
      const IconUser = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
      );
      const IconMap = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" />
          <line x1="8" y1="2" x2="8" y2="18" />
          <line x1="16" y1="6" x2="16" y2="22" />
        </svg>
      );
      const IconNetwork = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <rect x="16" y="16" width="6" height="6" rx="1" />
          <rect x="2" y="16" width="6" height="6" rx="1" />
          <rect x="9" y="2" width="6" height="6" rx="1" />
          <path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3" />
          <path d="M12 12V8" />
        </svg>
      );
      const IconTrash = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
        </svg>
      );
      const IconPlus = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      );
      const IconDownload = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" y1="15" x2="12" y2="3" />
        </svg>
      );
      const IconUpload = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
      );
      const IconCheck = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polyline points="20 6 9 17 4 12" />
        </svg>
      );

      // --- COMPONENTS ---

      // 1. MINDMAP COMPONENT (D3)
      const MindMap = ({ characters, locations }) => {
        const svgRef = useRef(null);
        const gRef = useRef(null); // Container for zoom

        useEffect(() => {
          if (!svgRef.current) return;

          // Prepare Data
          const nodes = [
            ...characters.map((c) => ({
              id: c.id,
              name: c.name,
              type: "character",
              img: c.image,
            })),
            ...locations.map((l) => ({
              id: l.id,
              name: l.name,
              type: "location",
              img: l.image,
            })),
          ];

          const links = [];

          // Link Characters to relationships
          characters.forEach((c) => {
            c.relationships.forEach((r) => {
              const target = nodes.find((n) => n.id === r.targetId);
              if (target) {
                links.push({ source: c.id, target: target.id, label: r.type });
              }
            });

            // Link Character to Home/Location if it exists
            if (c.countryId) {
              const loc = nodes.find((n) => n.id === c.countryId);
              if (loc)
                links.push({ source: c.id, target: loc.id, label: "Lives in" });
            }
          });

          // Link Locations to Residents
          locations.forEach((l) => {
            l.residents.forEach((resId) => {
              const char = nodes.find((n) => n.id === resId);
              const exists = links.find(
                (link) =>
                  (link.source === l.id && link.target === char.id) ||
                  (link.source === char.id && link.target === l.id)
              );
              if (char && !exists)
                links.push({
                  source: l.id,
                  target: char.id,
                  label: "Resident",
                });
            });
          });

          // --- D3 Setup ---
          const svg = d3.select(svgRef.current);

          // Clear previous *content* but keep the zoom grouping structure if we can, or just clear all
          // Simpler to clear all for React re-renders in this simple use case
          svg.selectAll("*").remove();

          // Add Group for Zooming
          const g = svg.append("g");
          gRef.current = g;

          const width = svgRef.current.clientWidth;
          const height = svgRef.current.clientHeight;

          // Zoom Behavior
          const zoom = d3
            .zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
              g.attr("transform", event.transform);
            });

          svg.call(zoom).on("dblclick.zoom", null); // Disable double click to zoom

          // Simulation
          const simulation = d3
            .forceSimulation(nodes)
            .force(
              "link",
              d3
                .forceLink(links)
                .id((d) => d.id)
                .distance(150)
            )
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(40));

          // Render Lines
          const link = g
            .append("g")
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("stroke", "#5c2a2a")
            .attr("stroke-opacity", 0.6)
            .attr("stroke-width", 2);

          // Render Nodes Container
          const node = g
            .append("g")
            .selectAll("g")
            .data(nodes)
            .enter()
            .append("g")
            .attr("cursor", "grab")
            .call(
              d3
                .drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

          // Node Circles
          node
            .append("circle")
            .attr("r", 25)
            .attr("fill", (d) =>
              d.type === "character" ? "#24283b" : "#4a2c2c"
            )
            .attr("stroke", "#e0af68")
            .attr("stroke-width", 2);

          // Images
          node
            .append("clipPath")
            .attr("id", (d) => "clip-" + d.id)
            .append("circle")
            .attr("r", 25);

          node
            .append("image")
            .attr(
              "xlink:href",
              (d) => d.img || "https://via.placeholder.com/50"
            )
            .attr("x", -25)
            .attr("y", -25)
            .attr("width", 50)
            .attr("height", 50)
            .attr("clip-path", (d) => "url(#clip-" + d.id + ")");

          // Labels
          node
            .append("text")
            .text((d) => d.name)
            .attr("x", 0)
            .attr("y", 40)
            .attr("text-anchor", "middle")
            .attr("fill", "#c0caf5")
            .style("font-size", "12px")
            .style("font-family", "Cinzel")
            .style("pointer-events", "none"); // Let clicks pass through to node

          // Link Labels
          const linkLabel = g
            .append("g")
            .selectAll("text")
            .data(links)
            .enter()
            .append("text")
            .text((d) => d.label)
            .attr("text-anchor", "middle")
            .attr("fill", "#666")
            .style("font-size", "10px");

          simulation.on("tick", () => {
            link
              .attr("x1", (d) => d.source.x)
              .attr("y1", (d) => d.source.y)
              .attr("x2", (d) => d.target.x)
              .attr("y2", (d) => d.target.y);

            node.attr("transform", (d) => `translate(${d.x},${d.y})`);

            linkLabel
              .attr("x", (d) => (d.source.x + d.target.x) / 2)
              .attr("y", (d) => (d.source.y + d.target.y) / 2);
          });

          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
            d3.select(this).attr("cursor", "grabbing");
          }

          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
            d3.select(this).attr("cursor", "grab");
          }

          return () => simulation.stop();
        }, [characters, locations]);

        return (
          <div className="w-full h-full bg-black/20 rounded-lg overflow-hidden border border-[#5c2a2a] relative">
            <div className="absolute top-2 left-2 z-10 text-xs text-gray-500 pointer-events-none p-2 bg-black/50 rounded">
              Scroll to Zoom • Drag background to Pan
            </div>
            <svg ref={svgRef} className="w-full h-[600px]"></svg>
          </div>
        );
      };

      // 2. MAIN APP
      const App = () => {
        const [view, setView] = useState("characters"); // characters, locations, mindmap
        const [characters, setCharacters] = useState([]);
        const [locations, setLocations] = useState([]);

        // Edit States
        const [editingChar, setEditingChar] = useState(null);
        const [editingLoc, setEditingLoc] = useState(null);

        // System States
        const [lastSaved, setLastSaved] = useState(null);
        const [isDirty, setIsDirty] = useState(false); // Dirty relative to FILE EXPORT

        // Initial Load
        useEffect(() => {
          const savedChars = localStorage.getItem("astral_chars");
          const savedLocs = localStorage.getItem("astral_locs");
          if (savedChars) setCharacters(JSON.parse(savedChars));
          if (savedLocs) setLocations(JSON.parse(savedLocs));
          setLastSaved(new Date());
        }, []);

        // AutoSave Effect (Immediate to LocalStorage)
        useEffect(() => {
          if (characters.length > 0 || locations.length > 0) {
            localStorage.setItem("astral_chars", JSON.stringify(characters));
            localStorage.setItem("astral_locs", JSON.stringify(locations));
            setLastSaved(new Date());
            setIsDirty(true); // Mark as dirty for file export
          }
        }, [characters, locations]);

        // Warn on Exit if Dirty
        useEffect(() => {
          const handleBeforeUnload = (e) => {
            if (isDirty) {
              const message =
                "You have unsaved changes that haven't been exported to a file. Are you sure you want to leave?";
              e.returnValue = message;
              return message;
            }
          };

          window.addEventListener("beforeunload", handleBeforeUnload);
          return () =>
            window.removeEventListener("beforeunload", handleBeforeUnload);
        }, [isDirty]);

        // --- Handlers ---

        const handleSaveChar = (char) => {
          if (characters.find((c) => c.id === char.id)) {
            setCharacters(characters.map((c) => (c.id === char.id ? char : c)));
          } else {
            setCharacters([...characters, char]);
          }
          setEditingChar(null);
        };

        const handleDeleteChar = (id) => {
          if (!confirm("Are you sure?")) return;
          setCharacters(characters.filter((c) => c.id !== id));
          setEditingChar(null);
        };

        const handleSaveLoc = (loc) => {
          if (locations.find((l) => l.id === loc.id)) {
            setLocations(locations.map((l) => (l.id === loc.id ? loc : l)));
          } else {
            setLocations([...locations, loc]);
          }
          setEditingLoc(null);
        };

        const handleDeleteLoc = (id) => {
          if (!confirm("Are you sure?")) return;
          setLocations(locations.filter((l) => l.id !== id));
          setEditingLoc(null);
        };

        // --- File Export/Import ---
        const handleExport = () => {
          const data = { characters, locations };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `astral_world_${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          setIsDirty(false); // Reset dirty flag
        };

        const handleImport = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (data.characters) setCharacters(data.characters);
              if (data.locations) setLocations(data.locations);
              alert("World data loaded successfully!");
              setIsDirty(false);
            } catch (err) {
              alert("Error loading file: " + err.message);
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        };

        return (
          <div className="min-h-screen flex flex-col relative">
            {/* Header */}
            <header className="flex flex-col md:flex-row justify-between items-center px-8 py-6 border-b border-[#5c2a2a] bg-[#1a1b26] gap-4">
              <div className="flex items-center gap-6">
                <h1 className="text-5xl text-[#e0af68] tracking-widest brand-font">
                  ASTRAL
                </h1>
                <div className="flex gap-2">
                  <button
                    onClick={handleExport}
                    className={`btn-secondary ${
                      isDirty
                        ? "animate-pulse border-yellow-500 text-yellow-500"
                        : ""
                    }`}
                    title="Save to File"
                  >
                    <IconDownload /> {isDirty ? "Save *" : "Saved"}
                  </button>
                  <label
                    className="btn-secondary cursor-pointer"
                    title="Load from File"
                  >
                    <IconUpload /> Load
                    <input
                      type="file"
                      className="hidden"
                      accept=".json"
                      onChange={handleImport}
                    />
                  </label>
                </div>
              </div>

              <nav className="flex gap-4">
                <button
                  onClick={() => {
                    setView("characters");
                    setEditingChar(null);
                  }}
                  className={`px-4 py-2 text-lg brand-font transition-all ${
                    view === "characters"
                      ? "bg-[#5c2a2a] text-white shadow-[0_0_10px_#5c2a2a]"
                      : "hover:text-[#e0af68]"
                  }`}
                >
                  Characters
                </button>
                <button
                  onClick={() => {
                    setView("locations");
                    setEditingLoc(null);
                  }}
                  className={`px-4 py-2 text-lg brand-font transition-all ${
                    view === "locations"
                      ? "bg-[#5c2a2a] text-white shadow-[0_0_10px_#5c2a2a]"
                      : "hover:text-[#e0af68]"
                  }`}
                >
                  Locations
                </button>
                <button
                  onClick={() => setView("mindmap")}
                  className={`px-4 py-2 text-lg brand-font transition-all ${
                    view === "mindmap"
                      ? "bg-[#5c2a2a] text-white shadow-[0_0_10px_#5c2a2a]"
                      : "hover:text-[#e0af68]"
                  }`}
                >
                  Mindmap
                </button>
              </nav>
            </header>

            {/* Main Content */}
            <main className="flex-grow p-8 container mx-auto mb-8">
              {view === "characters" &&
                (!editingChar ? (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center mb-8">
                      <h2 className="text-3xl brand-font text-white border-b border-[#5c2a2a] pb-2">
                        Character Roster
                      </h2>
                      <button
                        onClick={() =>
                          setEditingChar({
                            id: Date.now(),
                            name: "",
                            age: "",
                            race: "",
                            countryId: "",
                            class: "",
                            image: "",
                            relationships: [],
                          })
                        }
                        className="btn-primary flex items-center gap-2"
                      >
                        <IconPlus /> New Character
                      </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {characters.map((char) => (
                        <div
                          key={char.id}
                          onClick={() => setEditingChar(char)}
                          className="bg-[#24283b] p-4 rounded border border-[#5c2a2a] hover:border-[#e0af68] cursor-pointer transition-all group relative overflow-hidden"
                        >
                          <div className="h-48 w-full bg-black/50 mb-4 rounded overflow-hidden">
                            {char.image ? (
                              <img
                                src={char.image}
                                className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                              />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center text-gray-600 italic">
                                No Image
                              </div>
                            )}
                          </div>
                          <h3 className="text-2xl text-[#e0af68] brand-font mb-1">
                            {char.name || "Unnamed"}
                          </h3>
                          <p className="text-sm text-gray-400 uppercase tracking-widest mb-2">
                            {char.race} • {char.class}
                          </p>
                          <div className="w-10 h-1 bg-[#5c2a2a] mb-2"></div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <CharacterEditor
                    character={editingChar}
                    onSave={handleSaveChar}
                    onCancel={() => setEditingChar(null)}
                    onDelete={handleDeleteChar}
                    allCharacters={characters}
                    allLocations={locations}
                  />
                ))}

              {view === "locations" &&
                (!editingLoc ? (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center mb-8">
                      <h2 className="text-3xl brand-font text-white border-b border-[#5c2a2a] pb-2">
                        Known Locations
                      </h2>
                      <button
                        onClick={() =>
                          setEditingLoc({
                            id: Date.now(),
                            name: "",
                            biome: "",
                            species: "",
                            image: "",
                            residents: [],
                          })
                        }
                        className="btn-primary flex items-center gap-2"
                      >
                        <IconPlus /> New Location
                      </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                      {locations.map((loc) => (
                        <div
                          key={loc.id}
                          onClick={() => setEditingLoc(loc)}
                          className="bg-[#24283b] rounded-lg border border-[#5c2a2a] hover:border-[#e0af68] cursor-pointer overflow-hidden flex flex-col md:flex-row h-48 transition-all"
                        >
                          <div className="md:w-1/3 bg-black/50 h-full relative">
                            {loc.image ? (
                              <img
                                src={loc.image}
                                className="w-full h-full object-cover"
                              />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center text-gray-600 italic">
                                No Image
                              </div>
                            )}
                          </div>
                          <div className="p-6 flex-1 flex flex-col justify-center">
                            <h3 className="text-3xl text-[#e0af68] brand-font">
                              {loc.name || "Unknown Lands"}
                            </h3>
                            <p className="text-[#c0caf5]/70 italic mt-2">
                              {loc.biome}
                            </p>
                            <div className="mt-4 text-xs tracking-widest uppercase text-[#5c2a2a] font-bold">
                              Residents: {loc.residents.length}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <LocationEditor
                    location={editingLoc}
                    onSave={handleSaveLoc}
                    onCancel={() => setEditingLoc(null)}
                    onDelete={handleDeleteLoc}
                    allCharacters={characters}
                  />
                ))}

              {view === "mindmap" && (
                <div className="h-full">
                  <h2 className="text-3xl brand-font text-white mb-4">
                    Astral Connections
                  </h2>
                  <MindMap characters={characters} locations={locations} />
                </div>
              )}
            </main>

            {/* Autosave Footer Toast */}
            <div className="fixed bottom-4 right-4 flex items-center gap-2 bg-[#24283b] border border-[#5c2a2a] px-4 py-2 rounded-full shadow-lg transition-opacity duration-500">
              <div className="animate-pulse text-[#e0af68]">
                <IconCheck size={14} />
              </div>
              <span className="text-xs text-gray-400 uppercase tracking-widest">
                Autosaved {lastSaved ? lastSaved.toLocaleTimeString() : ""}
              </span>
            </div>
          </div>
        );
      };

      // 3. EDITOR COMPONENTS

      const CharacterEditor = ({
        character,
        onSave,
        onCancel,
        onDelete,
        allCharacters,
        allLocations,
      }) => {
        const [form, setForm] = useState(character);

        const addRel = () => {
          setForm({
            ...form,
            relationships: [
              ...form.relationships,
              { targetId: "", type: "Friend" },
            ],
          });
        };

        const updateRel = (idx, field, value) => {
          const newRels = [...form.relationships];
          newRels[idx][field] = value;
          setForm({ ...form, relationships: newRels });
        };

        const removeRel = (idx) => {
          setForm({
            ...form,
            relationships: form.relationships.filter((_, i) => i !== idx),
          });
        };

        return (
          <div className="max-w-4xl mx-auto bg-[#24283b] p-8 rounded border border-[#5c2a2a] shadow-2xl flex gap-8 flex-col md:flex-row">
            {/* Left: Image Card Look */}
            <div className="w-full md:w-1/3 flex flex-col gap-4">
              <div className="aspect-[3/4] bg-[#4a2c2c] rounded flex items-center justify-center overflow-hidden border-4 border-[#4a2c2c] shadow-inner relative group">
                {form.image ? (
                  <img
                    src={form.image}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <span className="brand-font text-2xl opacity-50 text-[#e0af68]">
                    [PICTURE]
                  </span>
                )}
                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4">
                  <label className="text-xs uppercase text-gray-400 mb-1">
                    Image URL
                  </label>
                  <input
                    type="text"
                    value={form.image}
                    onChange={(e) =>
                      setForm({ ...form, image: e.target.value })
                    }
                    className="input-std text-xs"
                    placeholder="https://..."
                  />
                </div>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => onSave(form)}
                  className="flex-1 btn-primary bg-[#e0af68] text-[#1a1b26] hover:bg-white font-bold"
                >
                  Save Profile
                </button>
                <button
                  onClick={() => onDelete(form.id)}
                  className="px-3 py-2 bg-red-900/50 hover:bg-red-900 text-white rounded"
                >
                  <IconTrash size={18} />
                </button>
              </div>
              <button
                onClick={onCancel}
                className="text-gray-500 hover:text-white text-sm underline"
              >
                Cancel
              </button>
            </div>

            {/* Right: Details */}
            <div className="flex-1 space-y-6">
              <div className="border-b border-[#5c2a2a] pb-4">
                <label className="text-xs uppercase tracking-widest text-[#5c2a2a] font-bold">
                  Full Name
                </label>
                <input
                  value={form.name}
                  onChange={(e) => setForm({ ...form, name: e.target.value })}
                  className="w-full bg-transparent text-4xl text-[#e0af68] brand-font border-none outline-none placeholder-[#e0af68]/20"
                  placeholder="CHARACTER NAME"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500">
                    Age
                  </label>
                  <input
                    value={form.age}
                    onChange={(e) => setForm({ ...form, age: e.target.value })}
                    className="input-std"
                    placeholder="Unknown"
                  />
                </div>
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500">
                    Race
                  </label>
                  <input
                    value={form.race}
                    onChange={(e) => setForm({ ...form, race: e.target.value })}
                    className="input-std"
                    placeholder="Human, Elf..."
                  />
                </div>
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500">
                    Class
                  </label>
                  <input
                    value={form.class}
                    onChange={(e) =>
                      setForm({ ...form, class: e.target.value })
                    }
                    className="input-std"
                    placeholder="Warrior, Mage..."
                  />
                </div>
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500">
                    Location/Country
                  </label>
                  <select
                    value={form.countryId}
                    onChange={(e) =>
                      setForm({ ...form, countryId: parseInt(e.target.value) })
                    }
                    className="input-std"
                  >
                    <option value="">-- Wandering --</option>
                    {allLocations.map((l) => (
                      <option key={l.id} value={l.id}>
                        {l.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="pt-4 border-t border-[#5c2a2a]/30">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="brand-font text-xl text-white">
                    Relationships
                  </h3>
                  <button
                    onClick={addRel}
                    type="button"
                    className="text-xs bg-[#5c2a2a] px-2 py-1 rounded hover:bg-[#e0af68] hover:text-black transition-colors"
                  >
                    + Add
                  </button>
                </div>

                <div className="space-y-2">
                  {form.relationships.length === 0 && (
                    <p className="text-gray-600 text-sm italic">
                      No relationships defined.
                    </p>
                  )}
                  {form.relationships.map((rel, idx) => (
                    <div key={idx} className="flex gap-2 items-center">
                      <select
                        value={rel.targetId}
                        onChange={(e) =>
                          updateRel(idx, "targetId", parseInt(e.target.value))
                        }
                        className="flex-1 input-std text-sm"
                      >
                        <option value="">Select Character...</option>
                        {allCharacters
                          .filter((c) => c.id !== form.id)
                          .map((c) => (
                            <option key={c.id} value={c.id}>
                              {c.name}
                            </option>
                          ))}
                      </select>
                      <input
                        value={rel.type}
                        onChange={(e) => updateRel(idx, "type", e.target.value)}
                        className="flex-1 input-std text-sm"
                        placeholder="Relation (e.g. Brother)"
                      />
                      <button
                        onClick={() => removeRel(idx)}
                        className="text-red-500 hover:text-red-400"
                      >
                        <IconTrash size={14} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const LocationEditor = ({
        location,
        onSave,
        onCancel,
        onDelete,
        allCharacters,
      }) => {
        const [form, setForm] = useState(location);

        // Handle multi-select for residents
        const toggleResident = (charId) => {
          const current = form.residents || [];
          if (current.includes(charId)) {
            setForm({
              ...form,
              residents: current.filter((id) => id !== charId),
            });
          } else {
            setForm({ ...form, residents: [...current, charId] });
          }
        };

        return (
          <div className="max-w-4xl mx-auto bg-[#24283b] p-8 rounded border border-[#5c2a2a] shadow-2xl">
            <div className="flex justify-between items-start mb-6 border-b border-[#5c2a2a] pb-4">
              <div className="w-full">
                <label className="text-xs uppercase tracking-widest text-[#5c2a2a] font-bold">
                  Location Name
                </label>
                <input
                  value={form.name}
                  onChange={(e) => setForm({ ...form, name: e.target.value })}
                  className="w-full bg-transparent text-4xl text-[#e0af68] brand-font border-none outline-none placeholder-[#e0af68]/20"
                  placeholder="LOCATION NAME"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => onSave(form)}
                  className="btn-primary bg-[#e0af68] text-[#1a1b26] hover:bg-white font-bold"
                >
                  Save
                </button>
                <button
                  onClick={() => onDelete(form.id)}
                  className="px-3 py-2 bg-red-900/50 hover:bg-red-900 text-white rounded"
                >
                  <IconTrash size={18} />
                </button>
                <button
                  onClick={onCancel}
                  className="px-3 py-2 text-gray-400 hover:text-white"
                >
                  Close
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="space-y-4">
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500">
                    Image URL
                  </label>
                  <input
                    value={form.image}
                    onChange={(e) =>
                      setForm({ ...form, image: e.target.value })
                    }
                    className="input-std"
                    placeholder="https://..."
                  />
                </div>
                <div className="h-48 bg-black/40 rounded overflow-hidden border border-[#5c2a2a]/30 flex items-center justify-center">
                  {form.image ? (
                    <img
                      src={form.image}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <span className="text-gray-600 italic">Preview</span>
                  )}
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs uppercase tracking-widest text-gray-500">
                      Biome
                    </label>
                    <input
                      value={form.biome}
                      onChange={(e) =>
                        setForm({ ...form, biome: e.target.value })
                      }
                      className="input-std"
                      placeholder="Forest, Desert..."
                    />
                  </div>
                  <div>
                    <label className="text-xs uppercase tracking-widest text-gray-500">
                      Dominant Species
                    </label>
                    <input
                      value={form.species}
                      onChange={(e) =>
                        setForm({ ...form, species: e.target.value })
                      }
                      className="input-std"
                      placeholder="Elves, Orcs..."
                    />
                  </div>
                </div>
              </div>

              <div>
                <h3 className="brand-font text-xl text-white mb-4">
                  Known Residents
                </h3>
                <div className="bg-[#1a1b26] p-4 rounded border border-[#5c2a2a]/30 h-64 overflow-y-auto">
                  {allCharacters.length === 0 && (
                    <p className="text-gray-600 italic">
                      No characters created yet.
                    </p>
                  )}
                  {allCharacters.map((char) => (
                    <label
                      key={char.id}
                      className="flex items-center gap-3 p-2 hover:bg-[#24283b] cursor-pointer rounded mb-1"
                    >
                      <input
                        type="checkbox"
                        checked={form.residents.includes(char.id)}
                        onChange={() => toggleResident(char.id)}
                        className="accent-[#e0af68]"
                      />
                      <div className="w-8 h-8 bg-black rounded-full overflow-hidden">
                        {char.image && (
                          <img
                            src={char.image}
                            className="w-full h-full object-cover"
                          />
                        )}
                      </div>
                      <span
                        className={
                          form.residents.includes(char.id)
                            ? "text-[#e0af68]"
                            : "text-gray-400"
                        }
                      >
                        {char.name}
                      </span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
